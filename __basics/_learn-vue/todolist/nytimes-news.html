<!DOCTYPE html>
<html>

<!--http://codepen.io/olayinkaos/pen/LWdWWY-->

<head>
    <meta charset="UTF-8">
    <title>VueJS and NYTimes News App</title>

    <link rel='stylesheet prefetch' href="https://cdn.bootcss.com/foundation/6.3.0-rc2/css/foundation.min.css">
    <style>
        .container {
            padding: 20px 0
        }

        .column:last-child:not(:first-child),
        .columns:last-child:not(:first-child) {
            float: left;
        }

        .main_heading {
            margin: 10px 0 30px;
        }

        .callout {
            margin-bottom: 40px;
        }

        select {
            text-transform: capitalize;
        }

        .loader {
            text-align: center;
            padding: 40px;
        }

        .uppercase {
            text-transform: uppercase;
        }
    </style>
</head>

<body>

<div class="container" id="app">
    <h3 class="text-center">VueNews</h3>

    <section class="callout secondary">
        <h5 class="text-center">Filter by Category</h5>
        <form>
            <div class="row">

                <div class="large-6 columns">
                    <select v-model="section">
                        <option v-for="section in sections" :value="section">{{ section }}</option>
                    </select>
                </div>

                <div class="large-6 columns">
                    <a @click="getPosts(section)" class="button expanded">Retrieve</a>
                </div>
            </div>
        </form>
    </section>

    <h5 class="text-center uppercase" v-if="!loading">{{ title }}</h5>


    <!-- 加载Loading -->
    <div
        v-if="loading"
        class="loader">
        <img src="http://cdnjs.cloudflare.com/ajax/libs/semantic-ui/0.16.1/images/loader-large.gif" alt="loader">
    </div>

    <!-- 列表 -->
    <news-list
        v-if="!loading"
        :results="results">
    </news-list>

</div>
<!-- ./container -->

<script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script type="application/ecmascript">

    // 参考自 http://codepen.io/SitePoint/pen/pPojGY
    // 接口
    const NYTBaseUrl = "https://api.nytimes.com/svc/topstories/v2/";
    const ApiKey = "df23ea8ad764441f88243048f634d370"; // replace with NYT API key

    // 下拉框 选项常量
    const SECTIONS = "home, arts, automobiles, books, \
        business, fashion, food, health, insider, \
        magazine, movies, national, nyregion, obituaries, \
        opinion, politics, realestate, science, sports, \
        sundayreview, technology, theater, tmagazine, travel, upshot, world";

    // 创建link
    // 公共方法
    function buildUrl(url) {
        // return 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/123941/nytimes-api.json';
        return NYTBaseUrl + url + ".json?api-key=" + ApiKey;
    }

    // 创建news-list组件
    Vue.component('news-list', {
        props: ['results'],
        template: `
            <section>
              <div class="row" v-for="posts in processedPosts">
                <div class="columns large-3 medium-6" v-for="post in posts">
                  <div class="card">
                      <div class="card-divider">
                      {{ post.title }}
                      </div>
                      <a :href="post.url" target="_blank"><img :src="post.image_url"></a>
                      <div class="card-section">
                        <p>{{ post.abstract }}</p>
                      </div>
                   </div>
                </div>
              </div>
            </section>
         `,

        computed: {

            // 处理请求
            processedPosts() {
                let posts = this.results;

                // Add image_url attribute
                posts.map(post => {
                    // 替换图片路径
                    let imgObj = post.multimedia.find(media => media.format === "superJumbo"); // 多媒体格式
                    post.image_url = imgObj ? imgObj.url : "http://placehold.it/300x200?text=N/A";
                });

                // Put Array into Chunks
                let i, j, chunkedArray = [], chunk = 4;
                for (i = 0, j = 0; i < posts.length; i += chunk, j++) {
                    chunkedArray[j] = posts.slice(i, i + chunk);
                }
                return chunkedArray;
            }
        }
    });

    // VM应用
    const vm = new Vue({
        el: '#app',
        data: {
            results: [],
            sections: SECTIONS.split(', '), // create an array of the sections
            section: 'home', // set default section to 'home'
            loading: true,
            title: ''
        },


        mounted() {
            // 默认加载
            this.getPosts('home');
        },

        methods: {
            // 发起请求
            getPosts(section) {
                // 请求链接
                let url = buildUrl(section);

                axios.get(url).then((response) => {
                    // 去除加载
                    this.loading = false;

                    // 追加标题数量
                    let title = (this.section !== 'home') ? "Top stories in '" + this.section + "' today" : "Top stories today";
                    this.title = title + "(" + response.data.num_results + ")";

                    // 显示结果
                    this.results = response.data.results;
                }).catch((error) => {
                    console.log(error);
                });
            }
        }
    });

</script>

</body>

</html>
